[
    {
        "$match": {
            "updatedAt": {
                "$gt": "{{ last_successful_dagrun_ds }}",
                "$lte": "{{ data_interval_end }}"
            }
        }
    },
    {
        "$addFields": {
            "items.link_order_child": "$link_order_child"
        }
    },
    {
        "$unwind": {
            "path": "$items",
            "includeArrayIndex": "arrayIndex"
        }
    },
    {
        "$replaceRoot": {
            "newRoot": {
                "$mergeObjects": [
                  {
                    "order_id": "$_id",
                    "arrayIndex": "$arrayIndex"
                  },
                  "$items"
                ]
            }
        }
    },
    { "$set": {
        "id": {
            "$concat": [
                {"$toString": "$order_id"},
                "__",
                {"$toString": "$_id"},
                "__",
                {"$toString": "$arrayIndex"}
            ]
        },
        "idx": "$arrayIndex",
        "item_id": "$_id",
        "discount": {
            "$convert": {
                "input": "$discount",
                "to": "int",
                "onError": 0,
                "onNull": 0
            }
        },
        "is_link_order_child_item": {
              "$cond": {
                  "if": {"$eq": ["$link_order_child", true]},
                  "then": 1,
                  "else": 0
              }
        }
      }
    },
    {
        "$project": {
            "items": 0,
            "_id": 0,
            "request_detail": 0,
            "parent_order_name":0
        }
    },
    { "$skip": 0 },
    { "$limit": 5000}
]
