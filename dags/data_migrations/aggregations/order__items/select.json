[
    {
        "$match": {
            "updatedAt": {
                "$gt": "{{ last_successful_dagrun_ds }}",
                "$lte": "{{ data_interval_end }}"
            }
        }
    },
    {
        "$unwind": {
            "path": "$items",
            "includeArrayIndex": "arrayIndex"
        }
    },
    {
        "$replaceRoot": {
            "newRoot": {
                "$mergeObjects": [
                  {
                    "order_id": "$_id",
                    "arrayIndex": "$arrayIndex"
                  },
                  "$items"
                ]
            }
        }
    },
    { "$set": {
        "id": {
            "$concat": [
                {"$toString": "$order_id"},
                "__",
                {"$toString": "$_id"},
                "__",
                {"$toString": "$arrayIndex"}
            ]
        },
        "discount": {
                "$convert": {
                    "input": "$discount",
                    "to": "int",
                    "onError": 0,
                    "onNull": 0
                }
            }
      }
    },
    {
        "$project": {
            "items": 0,
            "_id": 0,
            "request_detail": 0
        }
    },
    { "$skip": 0 },
    { "$limit": 5000}
]
